

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Unit Testing in ESP32 &mdash; ESP-IDF Programming Guide v4.1-dev-2071-gf91080637 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="https://media.readthedocs.com/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Wi-Fi Driver" href="wifi.html" />
    <link rel="prev" title="Unit Testing (Legacy GNU Make)" href="unit-tests-legacy.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/unit-tests.html" />

<link rel="stylesheet" href="https://media.readthedocs.com/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = "api-guides/unit-tests"
READTHEDOCS_DATA['source_suffix'] = ".rst"
</script>

<script type="text/javascript" src="https://media.readthedocs.com/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
<script async type="text/javascript" src="../../../../../_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="espressif-esp-idf" /><meta name="readthedocs-version-slug" content="latest" /><meta name="readthedocs-resolver-filename" content="/api-guides/unit-tests.html" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> ESP-IDF Programming Guide
          

          
            
            <img src="../_static/espressif-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw-reference/index.html">H/W Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../esp32s2.html">ESP32-S2 Preview Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="app_trace.html">Application Level Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="blufi.html">BluFi</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootloader.html">Bootloader</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-system.html">Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-system-legacy.html">Build System (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">Console Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="deep-sleep-stub.html">Deep Sleep Wake Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="esp-ble-mesh/ble-mesh-index.html">ESP-BLE-MESH</a></li>
<li class="toctree-l2"><a class="reference internal" href="mesh.html">ESP-MESH (Wi-Fi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_dump.html">ESP32 Core Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-handling.html">Event Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="external-ram.html">External SPI-connected RAM</a></li>
<li class="toctree-l2"><a class="reference internal" href="fatal-errors.html">Fatal Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/flash-encryption.html">Flash Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="freertos-smp.html">FreeRTOS SMP Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="general-notes.html">General Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="hlinterrupts.html">High Level Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="jtag-debugging/index.html">JTAG Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="linker-script-generation.html">Linker Script Generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="lwip.html">lwIP TCP/IP Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="partition-tables.html">Partition Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="RF_calibration.html">RF Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="romconsole.html">ROM debug console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/secure-boot.html">Secure Boot</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread-local-storage.html">Thread Local Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools/index.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="ulp.html">ULP Coprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="ulp-legacy.html">ULP Coprocessor (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit-tests-legacy.html">Unit Testing (Legacy GNU Make)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="unit-tests.html#">Unit Testing</a><ul>
<li class="toctree-l3"><a class="reference internal" href="unit-tests.html#normal-test-cases">Normal Test Cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit-tests.html#multi-device-test-cases">Multi-device Test Cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit-tests.html#multi-stage-test-cases">Multi-stage Test Cases</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit-tests.html#building-unit-test-app">Building Unit Test App</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit-tests.html#running-unit-tests">Running Unit Tests</a></li>
<li class="toctree-l3"><a class="reference internal" href="unit-tests.html#timing-code-with-cache-compensated-timer">Timing Code with Cache Compensated Timer</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">WiFi Driver</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../libraries-and-frameworks/index.html">Libraries and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyrights</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages.html">语言/Languages</a></li>
<li class="toctree-l1"><a class="reference external" href="https://readthedocs.com/projects/espressif-esp-idf/downloads/">Guide Downloads</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ESP-IDF Programming Guide</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">API Guides</a> &raquo;</li>
        
      <li>Unit Testing in ESP32</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/espressif/esp-idf/blob/master/docs/en/api-guides/unit-tests.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="unit-testing-in-esp32">
<h1>Unit Testing in ESP32<a class="headerlink" href="unit-tests.html#unit-testing-in-esp32" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://espressif-docs.readthedocs-hosted.com/projects/esp-idf/zh_CN/latest/api-guides/unit-tests.html">[中文]</a></p>
<p>ESP-IDF comes with a unit test application that is based on the Unity - unit test framework. Unit tests are integrated in the ESP-IDF repository and are placed in the <code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectories of each component respectively.</p>
<div class="section" id="normal-test-cases">
<h2>Normal Test Cases<a class="headerlink" href="unit-tests.html#normal-test-cases" title="Permalink to this headline">¶</a></h2>
<p>Unit tests are located in the <code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectory of a component.
Tests are written in C, and a single C source file can contain multiple test cases.
Test files start with the word “test”.</p>
<p>Each test file should include the <code class="docutils literal notranslate"><span class="pre">unity.h</span></code> header and the header for the C module to be tested.</p>
<p>Tests are added in a function in the C file as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">TEST_CASE</span><span class="p">(</span><span class="s">&quot;test name&quot;</span><span class="p">,</span> <span class="s">&quot;[module name]&quot;</span>
<span class="p">{</span>
        <span class="c1">// Add test here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The first argument is a descriptive name for the test, the second argument is an identifier in square brackets.
Identifiers are used to group related test, or tests with specific properties.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no need to add a main function with <code class="docutils literal notranslate"><span class="pre">UNITY_BEGIN()</span></code> and <code class="docutils literal notranslate"><span class="pre">​UNITY_END()</span></code> in each test case. <code class="docutils literal notranslate"><span class="pre">unity_platform.c</span></code> will run <code class="docutils literal notranslate"><span class="pre">UNITY_BEGIN()</span></code> autonomously, and run the test cases, then call <code class="docutils literal notranslate"><span class="pre">​UNITY_END()</span></code>.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectory should contain a <a class="reference internal" href="build-system.html#component-directories"><span class="std std-ref">component CMakeLists.txt</span></a>, since they are themselves, components. ESP-IDF uses the <code class="docutils literal notranslate"><span class="pre">unity</span></code> test framework and should be specified as a requirement for the component. Normally, components <a class="reference internal" href="build-system.html#cmake-file-globbing"><span class="std std-ref">should list their sources manually</span></a>; for component tests however, this requirement is relaxed and the use of the <code class="docutils literal notranslate"><span class="pre">SRC_DIRS</span></code> argument in <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> is advised.</p>
<p>Overall, the minimal <code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectory <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file should contain the following:</p>
<div class="code cmake highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">idf_component_register</span><span class="p">(</span><span class="n">SRC_DIRS</span> <span class="s2">&quot;.&quot;</span>
                       <span class="n">INCLUDE_DIRS</span> <span class="s2">&quot;.&quot;</span>
                       <span class="n">REQUIRES</span> <span class="n">unity</span><span class="p">)</span>
</pre></div>
</div>
<p>See <a class="reference external" href="http://www.throwtheswitch.org/unity">http://www.throwtheswitch.org/unity</a> for more information about writing tests in Unity.</p>
</div>
<div class="section" id="multi-device-test-cases">
<h2>Multi-device Test Cases<a class="headerlink" href="unit-tests.html#multi-device-test-cases" title="Permalink to this headline">¶</a></h2>
<p>The normal test cases will be executed on one DUT (Device Under Test). However, components that require some form of communication (e.g., GPIO, SPI) require another device to communicate with, thus cannot be tested normal test cases.
Multi-device test cases involve writing multiple test functions, and running them on multiple DUTs.</p>
<p>The following is an example of a multi-device test case:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">gpio_master_test</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">gpio_config_t</span> <span class="n">slave_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">.</span><span class="n">pin_bit_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MASTER_GPIO_PIN</span><span class="p">,</span>
            <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_INPUT</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="n">gpio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slave_config</span><span class="p">);</span>
    <span class="n">unity_wait_for_signal</span><span class="p">(</span><span class="s">&quot;output high level&quot;</span><span class="p">);</span>
    <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">gpio_get_level</span><span class="p">(</span><span class="n">MASTER_GPIO_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">gpio_slave_test</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">gpio_config_t</span> <span class="n">master_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">.</span><span class="n">pin_bit_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">SLAVE_GPIO_PIN</span><span class="p">,</span>
            <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">GPIO_MODE_OUTPUT</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="n">gpio_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master_config</span><span class="p">);</span>
    <span class="n">gpio_set_level</span><span class="p">(</span><span class="n">SLAVE_GPIO_PIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">unity_send_signal</span><span class="p">(</span><span class="s">&quot;output high level&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST_CASE_MULTIPLE_DEVICES</span><span class="p">(</span><span class="s">&quot;gpio multiple devices test example&quot;</span><span class="p">,</span> <span class="s">&quot;[driver]&quot;</span><span class="p">,</span> <span class="n">gpio_master_test</span><span class="p">,</span> <span class="n">gpio_slave_test</span><span class="p">);</span>
</pre></div>
</div>
<p>The macro <code class="docutils literal notranslate"><span class="pre">TEST_CASE_MULTIPLE_DEVICES</span></code> is used to declare a multi-device test case.
The first argument is test case name, the second argument is test case description.
From the third argument, up to 5 test functions can be defined, each function will be the entry point of tests running on each DUT.</p>
<p>Running test cases from different DUTs could require synchronizing between DUTs. We provide <code class="docutils literal notranslate"><span class="pre">unity_wait_for_signal</span></code> and <code class="docutils literal notranslate"><span class="pre">unity_send_signal</span></code> to support synchronizing with UART.
As the scenario in the above example, the slave should get GPIO level after master set level. DUT UART console will prompt and user interaction is required:</p>
<p>DUT1 (master) console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Waiting for signal: [output high level]!
Please press &quot;Enter&quot; key to once any board send this signal.
</pre></div>
</div>
<p>DUT2 (slave) console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Send signal: [output high level]!
</pre></div>
</div>
<p>Once the signal is sent from DUT2, you need to press “Enter” on DUT1, then DUT1 unblocks from <code class="docutils literal notranslate"><span class="pre">unity_wait_for_signal</span></code> and starts to change GPIO level.</p>
</div>
<div class="section" id="multi-stage-test-cases">
<h2>Multi-stage Test Cases<a class="headerlink" href="unit-tests.html#multi-stage-test-cases" title="Permalink to this headline">¶</a></h2>
<p>The normal test cases are expected to finish without reset (or only need to check if reset happens). Sometimes we expect to run some specific tests after certain kinds of reset.
For example, we expect to test if the reset reason is correct after a wakeup from deep sleep. We need to create a deep-sleep reset first and then check the reset reason.
To support this, we can define multi-stage test cases, to group a set of test functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">void</span> <span class="n">trigger_deepsleep</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">esp_sleep_enable_timer_wakeup</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>
    <span class="n">esp_deep_sleep_start</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">check_deepsleep_reset_reason</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">RESET_REASON</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">rtc_get_reset_reason</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">TEST_ASSERT</span><span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">DEEPSLEEP_RESET</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">TEST_CASE_MULTIPLE_STAGES</span><span class="p">(</span><span class="s2">&quot;reset reason check for deepsleep&quot;</span><span class="p">,</span> <span class="s2">&quot;[esp32]&quot;</span><span class="p">,</span> <span class="n">trigger_deepsleep</span><span class="p">,</span> <span class="n">check_deepsleep_reset_reason</span><span class="p">);</span>
</pre></div>
</div>
<p>Multi-stage test cases present a group of test functions to users. It needs user interactions (select cases and select different stages) to run the case.</p>
</div>
<div class="section" id="building-unit-test-app">
<h2>Building Unit Test App<a class="headerlink" href="unit-tests.html#building-unit-test-app" title="Permalink to this headline">¶</a></h2>
<p>Follow the setup instructions in the top-level esp-idf README.
Make sure that <code class="docutils literal notranslate"><span class="pre">IDF_PATH</span></code> environment variable is set to point to the path of esp-idf top-level directory.</p>
<p>Change into <code class="docutils literal notranslate"><span class="pre">tools/unit-test-app</span></code> directory to configure and build it:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">menuconfig</span></code> - configure unit test app.</li>
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-T</span> <span class="pre">all</span> <span class="pre">build</span></code> - build unit test app with tests for each component having tests in the <code class="docutils literal notranslate"><span class="pre">test</span></code> subdirectory.</li>
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-T</span> <span class="pre">xxx</span> <span class="pre">build</span></code> - build unit test app with tests for specific components.</li>
<li><code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-T</span> <span class="pre">all</span> <span class="pre">-E</span> <span class="pre">xxxbuild</span></code> - build unit test app with all unit tests, except for unit tests of some components. (For instance: <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-T</span> <span class="pre">all</span> <span class="pre">-E</span> <span class="pre">ulp</span> <span class="pre">mbedtls</span> <span class="pre">build</span></code> - build all unit tests exludes <code class="docutils literal notranslate"><span class="pre">ulp</span></code> and <code class="docutils literal notranslate"><span class="pre">mbedtls</span></code> components).</li>
</ul>
<p>When the build finishes, it will print instructions for flashing the chip. You can simply run <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">flash</span></code> to flash all build output.</p>
<p>You can also run <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-T</span> <span class="pre">all</span> <span class="pre">flash</span></code> or <code class="docutils literal notranslate"><span class="pre">idf.py</span> <span class="pre">-T</span> <span class="pre">xxx</span> <span class="pre">flash</span></code> to build and flash. Everything needed will be rebuilt automatically before flashing.</p>
<p>Use menuconfig to set the serial port for flashing.</p>
</div>
<div class="section" id="running-unit-tests">
<h2>Running Unit Tests<a class="headerlink" href="unit-tests.html#running-unit-tests" title="Permalink to this headline">¶</a></h2>
<p>After flashing reset the ESP32 and it will boot the unit test app.</p>
<p>When unit test app is idle, press “Enter” will make it print test menu with all available tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Here</span><span class="s1">&#39;s the test menu, pick your combo:</span>
<span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="s2">&quot;esp_ota_begin() verifies arguments&quot;</span> <span class="p">[</span><span class="n">ota</span><span class="p">]</span>
<span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="s2">&quot;esp_ota_get_next_update_partition logic&quot;</span> <span class="p">[</span><span class="n">ota</span><span class="p">]</span>
<span class="p">(</span><span class="mi">3</span><span class="p">)</span>     <span class="s2">&quot;Verify bootloader image in flash&quot;</span> <span class="p">[</span><span class="n">bootloader_support</span><span class="p">]</span>
<span class="p">(</span><span class="mi">4</span><span class="p">)</span>     <span class="s2">&quot;Verify unit test app image&quot;</span> <span class="p">[</span><span class="n">bootloader_support</span><span class="p">]</span>
<span class="p">(</span><span class="mi">5</span><span class="p">)</span>     <span class="s2">&quot;can use new and delete&quot;</span> <span class="p">[</span><span class="n">cxx</span><span class="p">]</span>
<span class="p">(</span><span class="mi">6</span><span class="p">)</span>     <span class="s2">&quot;can call virtual functions&quot;</span> <span class="p">[</span><span class="n">cxx</span><span class="p">]</span>
<span class="p">(</span><span class="mi">7</span><span class="p">)</span>     <span class="s2">&quot;can use static initializers for non-POD types&quot;</span> <span class="p">[</span><span class="n">cxx</span><span class="p">]</span>
<span class="p">(</span><span class="mi">8</span><span class="p">)</span>     <span class="s2">&quot;can use std::vector&quot;</span> <span class="p">[</span><span class="n">cxx</span><span class="p">]</span>
<span class="p">(</span><span class="mi">9</span><span class="p">)</span>     <span class="s2">&quot;static initialization guards work as expected&quot;</span> <span class="p">[</span><span class="n">cxx</span><span class="p">]</span>
<span class="p">(</span><span class="mi">10</span><span class="p">)</span>    <span class="s2">&quot;global initializers run in the correct order&quot;</span> <span class="p">[</span><span class="n">cxx</span><span class="p">]</span>
<span class="p">(</span><span class="mi">11</span><span class="p">)</span>    <span class="s2">&quot;before scheduler has started, static initializers work correctly&quot;</span> <span class="p">[</span><span class="n">cxx</span><span class="p">]</span>
<span class="p">(</span><span class="mi">12</span><span class="p">)</span>    <span class="s2">&quot;adc2 work with wifi&quot;</span> <span class="p">[</span><span class="n">adc</span><span class="p">]</span>
<span class="p">(</span><span class="mi">13</span><span class="p">)</span>    <span class="s2">&quot;gpio master/slave test example&quot;</span> <span class="p">[</span><span class="n">ignore</span><span class="p">][</span><span class="n">misc</span><span class="p">][</span><span class="n">test_env</span><span class="o">=</span><span class="n">UT_T2_1</span><span class="p">][</span><span class="n">multi_device</span><span class="p">]</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="s2">&quot;gpio_master_test&quot;</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="s2">&quot;gpio_slave_test&quot;</span>
<span class="p">(</span><span class="mi">14</span><span class="p">)</span>    <span class="s2">&quot;SPI Master clockdiv calculation routines&quot;</span> <span class="p">[</span><span class="n">spi</span><span class="p">]</span>
<span class="p">(</span><span class="mi">15</span><span class="p">)</span>    <span class="s2">&quot;SPI Master test&quot;</span> <span class="p">[</span><span class="n">spi</span><span class="p">][</span><span class="n">ignore</span><span class="p">]</span>
<span class="p">(</span><span class="mi">16</span><span class="p">)</span>    <span class="s2">&quot;SPI Master test, interaction of multiple devs&quot;</span> <span class="p">[</span><span class="n">spi</span><span class="p">][</span><span class="n">ignore</span><span class="p">]</span>
<span class="p">(</span><span class="mi">17</span><span class="p">)</span>    <span class="s2">&quot;SPI Master no response when switch from host1 (HSPI) to host2 (VSPI)&quot;</span> <span class="p">[</span><span class="n">spi</span><span class="p">]</span>
<span class="p">(</span><span class="mi">18</span><span class="p">)</span>    <span class="s2">&quot;SPI Master DMA test, TX and RX in different regions&quot;</span> <span class="p">[</span><span class="n">spi</span><span class="p">]</span>
<span class="p">(</span><span class="mi">19</span><span class="p">)</span>    <span class="s2">&quot;SPI Master DMA test: length, start, not aligned&quot;</span> <span class="p">[</span><span class="n">spi</span><span class="p">]</span>
<span class="p">(</span><span class="mi">20</span><span class="p">)</span>    <span class="s2">&quot;reset reason check for deepsleep&quot;</span> <span class="p">[</span><span class="n">esp32</span><span class="p">][</span><span class="n">test_env</span><span class="o">=</span><span class="n">UT_T2_1</span><span class="p">][</span><span class="n">multi_stage</span><span class="p">]</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="s2">&quot;trigger_deepsleep&quot;</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="s2">&quot;check_deepsleep_reset_reason&quot;</span>
</pre></div>
</div>
<p>The normal case will print the case name and description. Master-slave cases will also print the sub-menu (the registered test function names).</p>
<p>Test cases can be run by inputting one of the following:</p>
<ul class="simple">
<li>Test case name in quotation marks to run a single test case</li>
<li>Test case index to run a single test case</li>
<li>Module name in square brackets to run all test cases for a specific module</li>
<li>An asterisk to run all test cases</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">[multi_device]</span></code> and <code class="docutils literal notranslate"><span class="pre">[multi_stage]</span></code> tags tell the test runner whether a test case is a multiple devices or multiple stages of test case.
These tags are automatically added by <code class="docutils literal notranslate"><span class="pre">`TEST_CASE_MULTIPLE_STAGES</span></code> and <code class="docutils literal notranslate"><span class="pre">TEST_CASE_MULTIPLE_DEVICES</span></code> macros.</p>
<p>After you select a multi-device test case, it will print sub-menu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="n">gpio</span> <span class="n">master</span><span class="o">/</span><span class="n">slave</span> <span class="n">test</span> <span class="n">example</span><span class="o">...</span>
<span class="n">gpio</span> <span class="n">master</span><span class="o">/</span><span class="n">slave</span> <span class="n">test</span> <span class="n">example</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="s2">&quot;gpio_master_test&quot;</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="s2">&quot;gpio_slave_test&quot;</span>
</pre></div>
</div>
<p>You need to input a number to select the test running on the DUT.</p>
<p>Similar to multi-device test cases, multi-stage test cases will also print sub-menu:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="n">reset</span> <span class="n">reason</span> <span class="n">check</span> <span class="k">for</span> <span class="n">deepsleep</span><span class="o">...</span>
<span class="n">reset</span> <span class="n">reason</span> <span class="n">check</span> <span class="k">for</span> <span class="n">deepsleep</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">)</span>     <span class="s2">&quot;trigger_deepsleep&quot;</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">)</span>     <span class="s2">&quot;check_deepsleep_reset_reason&quot;</span>
</pre></div>
</div>
<p>First time you execute this case, input <code class="docutils literal notranslate"><span class="pre">1</span></code> to run first stage (trigger deepsleep).
After DUT is rebooted and able to run test cases, select this case again and input <code class="docutils literal notranslate"><span class="pre">2</span></code> to run the second stage.
The case only passes if the last stage passes and all previous stages trigger reset.</p>
</div>
<div class="section" id="timing-code-with-cache-compensated-timer">
<h2>Timing Code with Cache Compensated Timer<a class="headerlink" href="unit-tests.html#timing-code-with-cache-compensated-timer" title="Permalink to this headline">¶</a></h2>
<p>Instructions and data stored in external memory (e.g. SPI Flash and SPI RAM) are accessed through the CPU’s unified instruction and data cache. When code or data is in cache, access is very fast (i.e., a cache hit).</p>
<p>However, if the instruction or data is not in cache, it needs to be fetched from external memory (i.e., a cache miss). Access to external memory is significantly slower, as the CPU must execute stall cycles whilst waiting for the instruction or data to be retrieved from external memory. This can cause the overall code execution speed to vary depending on the number of cache hits or misses.</p>
<p>Code and data placements can vary between builds, and some arrangements may be more favorable with regards to cache access (i.e., minimizing cache misses). This can technically affect execution speed, however these factors are usually irrelevant as their effect ‘average out’ over the device’s operation.</p>
<p>The effect of the cache on execution speed, however, can be relevant in benchmarking scenarios (espcially microbenchmarks). There might be some variability in measured time
between runs and between different builds. A technique for eliminating for some of the
variability is to place code and data in instruction or data RAM (IRAM/DRAM), respectively. The CPU can access IRAM and DRAM directly, eliminating the cache out of the equation.
However, this might not always be viable as the size of IRAM and DRAM is limited.</p>
<p>The cache compensated timer is an alternative to placing the code/data to be benchmarked in IRAM/DRAM. This timer uses the processor’s internal event counters in order to determine the amount
of time spent on waiting for code/data in case of a cache miss, then subtract that from the recorded wall time.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Start the timer</span>
<span class="n">ccomp_timer_start</span><span class="p">();</span>

<span class="c1">// Function to time</span>
<span class="n">func_code_to_time</span><span class="p">();</span>

<span class="c1">// Stop the timer, and return the elapsed time in microseconds relative to</span>
<span class="c1">// ccomp_timer_start</span>
<span class="kt">int64_t</span> <span class="n">t</span> <span class="o">=</span> <span class="n">ccomp_timer_stop</span><span class="p">();</span>
</pre></div>
</div>
</div></blockquote>
<p>One limitation of the cache compensated timer is that the task that benchmarked functions should be pinned to a core. This is due to each core having its own event counters that are independent of each other. For example, if <code class="docutils literal notranslate"><span class="pre">ccomp_timer_start</span></code> gets called on one core, put to sleep by the scheduler, wakes up, and gets rescheduled on the other core, then the corresponding <code class="docutils literal notranslate"><span class="pre">ccomp_timer_stop</span></code> will be invalid.
invalid.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="wifi.html" class="btn btn-neutral float-right" title="Wi-Fi Driver" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="unit-tests-legacy.html" class="btn btn-neutral float-left" title="Unit Testing (Legacy GNU Make)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 - 2019, Espressif Systems (Shanghai) CO., LTD
      
        <span class="commit">
          Revision <code>f9108063</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>