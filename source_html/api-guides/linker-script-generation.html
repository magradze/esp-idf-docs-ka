

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Linker Script Generation &mdash; ESP-IDF Programming Guide v4.1-dev-2071-gf91080637 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="https://media.readthedocs.com/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="lwIP" href="lwip.html" />
    <link rel="prev" title="Tips and Quirks" href="jtag-debugging/tips-and-quirks.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="https://docs.espressif.com/projects/esp-idf/en/latest/api-guides/linker-script-generation.html" />

<link rel="stylesheet" href="https://media.readthedocs.com/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = "api-guides/linker-script-generation"
READTHEDOCS_DATA['source_suffix'] = ".rst"
</script>

<script type="text/javascript" src="https://media.readthedocs.com/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
<script async type="text/javascript" src="../../../../../_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="espressif-esp-idf" /><meta name="readthedocs-version-slug" content="latest" /><meta name="readthedocs-resolver-filename" content="/api-guides/linker-script-generation.html" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> ESP-IDF Programming Guide
          

          
            
            <img src="../_static/espressif-logo.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../get-started/index.html">Get Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api-reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hw-reference/index.html">H/W Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../esp32s2.html">ESP32-S2 Preview Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">API Guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="app_trace.html">Application Level Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="blufi.html">BluFi</a></li>
<li class="toctree-l2"><a class="reference internal" href="bootloader.html">Bootloader</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-system.html">Build System</a></li>
<li class="toctree-l2"><a class="reference internal" href="build-system-legacy.html">Build System (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">Console Component</a></li>
<li class="toctree-l2"><a class="reference internal" href="deep-sleep-stub.html">Deep Sleep Wake Stubs</a></li>
<li class="toctree-l2"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="esp-ble-mesh/ble-mesh-index.html">ESP-BLE-MESH</a></li>
<li class="toctree-l2"><a class="reference internal" href="mesh.html">ESP-MESH (Wi-Fi)</a></li>
<li class="toctree-l2"><a class="reference internal" href="core_dump.html">ESP32 Core Dump</a></li>
<li class="toctree-l2"><a class="reference internal" href="event-handling.html">Event Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="external-ram.html">External SPI-connected RAM</a></li>
<li class="toctree-l2"><a class="reference internal" href="fatal-errors.html">Fatal Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/flash-encryption.html">Flash Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="freertos-smp.html">FreeRTOS SMP Changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="general-notes.html">General Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="hlinterrupts.html">High Level Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="jtag-debugging/index.html">JTAG Debugging</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="linker-script-generation.html#">Linker Script Generation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="linker-script-generation.html#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="linker-script-generation.html#quick-start">Quick Start</a><ul>
<li class="toctree-l4"><a class="reference internal" href="linker-script-generation.html#creating-and-specifying-a-linker-fragment-file">Creating and Specifying a Linker Fragment File</a></li>
<li class="toctree-l4"><a class="reference internal" href="linker-script-generation.html#specifying-placements">Specifying placements</a></li>
<li class="toctree-l4"><a class="reference internal" href="linker-script-generation.html#the-default-placements">The ‘default’ placements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="linker-script-generation.html#linker-script-generation-internals">Linker Script Generation Internals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="linker-script-generation.html#linker-fragment-files">Linker Fragment Files</a></li>
<li class="toctree-l4"><a class="reference internal" href="linker-script-generation.html#linker-script-template">Linker Script Template</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lwip.html">lwIP TCP/IP Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="partition-tables.html">Partition Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="RF_calibration.html">RF Calibration</a></li>
<li class="toctree-l2"><a class="reference internal" href="romconsole.html">ROM debug console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/secure-boot.html">Secure Boot</a></li>
<li class="toctree-l2"><a class="reference internal" href="thread-local-storage.html">Thread Local Storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="tools/index.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="ulp.html">ULP Coprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="ulp-legacy.html">ULP Coprocessor (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit-tests-legacy.html">Unit Testing (Legacy GNU Make)</a></li>
<li class="toctree-l2"><a class="reference internal" href="unit-tests.html">Unit Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="wifi.html">WiFi Driver</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../libraries-and-frameworks/index.html">Libraries and Frameworks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference internal" href="../versions.html">Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../COPYRIGHT.html">Copyrights</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages.html">语言/Languages</a></li>
<li class="toctree-l1"><a class="reference external" href="https://readthedocs.com/projects/espressif-esp-idf/downloads/">Guide Downloads</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ESP-IDF Programming Guide</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">API Guides</a> &raquo;</li>
        
      <li>Linker Script Generation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/espressif/esp-idf/blob/master/docs/en/api-guides/linker-script-generation.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linker-script-generation">
<h1>Linker Script Generation<a class="headerlink" href="linker-script-generation.html#linker-script-generation" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://espressif-docs.readthedocs-hosted.com/projects/esp-idf/zh_CN/latest/api-guides/linker-script-generation.html">[中文]</a></p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="linker-script-generation.html#overview" title="Permalink to this headline">¶</a></h2>
<p>There are several <a class="reference internal" href="general-notes.html#memory-layout"><span class="std std-ref">memory regions</span></a> where code and data can be placed. Code and read-only data are placed by default in flash,
writable data in RAM, etc. However, it is sometimes necessary to change these default placements. For example, it may
be necessary to place critical code in RAM for performance reasons or to place code in RTC memory for use in a wake stub or the ULP coprocessor.</p>
<p>With the linker script generation mechanism, it is possible to specify these placements at the component level within ESP-IDF. The component presents
information on how it would like to place its symbols, objects or the entire archive. During build the information presented by the components are collected,
parsed and processed; and the placement rules generated is used to link the app.</p>
</div>
<div class="section" id="quick-start">
<h2>Quick Start<a class="headerlink" href="linker-script-generation.html#quick-start" title="Permalink to this headline">¶</a></h2>
<p>This section presents a guide for quickly placing code/data to RAM and RTC memory - placements ESP-IDF provides out-of-the-box.</p>
<p>For this guide, suppose we have the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span> <span class="n">components</span><span class="o">/</span>
                <span class="o">-</span> <span class="n">my_component</span><span class="o">/</span>
                                <span class="o">-</span> <span class="n">CMakeLists</span><span class="o">.</span><span class="n">txt</span>
                                <span class="o">-</span> <span class="n">component</span><span class="o">.</span><span class="n">mk</span>
                                <span class="o">-</span> <span class="n">Kconfig</span>
                                <span class="o">-</span> <span class="n">src</span><span class="o">/</span>
                                      <span class="o">-</span> <span class="n">my_src1</span><span class="o">.</span><span class="n">c</span>
                                      <span class="o">-</span> <span class="n">my_src2</span><span class="o">.</span><span class="n">c</span>
                                      <span class="o">-</span> <span class="n">my_src3</span><span class="o">.</span><span class="n">c</span>
                                <span class="o">-</span> <span class="n">my_linker_fragment_file</span><span class="o">.</span><span class="n">lf</span>
</pre></div>
</div>
<ul class="simple">
<li>a component named <code class="docutils literal notranslate"><span class="pre">my_component</span></code> that is archived as library <code class="docutils literal notranslate"><span class="pre">libmy_component.a</span></code> during build</li>
<li>three source files archived under the library, <code class="docutils literal notranslate"><span class="pre">my_src1.c</span></code>, <code class="docutils literal notranslate"><span class="pre">my_src2.c</span></code> and <code class="docutils literal notranslate"><span class="pre">my_src3.c</span></code> which are compiled as <code class="docutils literal notranslate"><span class="pre">my_src1.o</span></code>, <code class="docutils literal notranslate"><span class="pre">my_src2.o</span></code> and <code class="docutils literal notranslate"><span class="pre">my_src3.o</span></code>, respectively</li>
<li>under <code class="docutils literal notranslate"><span class="pre">my_src1.o</span></code>, the function <code class="docutils literal notranslate"><span class="pre">my_function1</span></code> is defined; under <code class="docutils literal notranslate"><span class="pre">my_src2.o</span></code>, the function <code class="docutils literal notranslate"><span class="pre">my_function2</span></code> is defined</li>
<li>there exist bool-type config <code class="docutils literal notranslate"><span class="pre">PERFORMANCE_MODE</span></code> (y/n) and int type config <code class="docutils literal notranslate"><span class="pre">PERFORMANCE_LEVEL</span></code> (with range 0-3) in my_component’s Kconfig</li>
</ul>
<div class="section" id="creating-and-specifying-a-linker-fragment-file">
<h3>Creating and Specifying a Linker Fragment File<a class="headerlink" href="linker-script-generation.html#creating-and-specifying-a-linker-fragment-file" title="Permalink to this headline">¶</a></h3>
<p>Before anything else, a linker fragment file needs to be created. A linker fragment file
is simply a text file with a <code class="docutils literal notranslate"><span class="pre">.lf</span></code> extension upon which the desired placements will be written.
After creating the file, it is then necessary to present it to the build system. The instructions for the build systems
supported by ESP-IDF are as follows:</p>
<div class="section" id="make">
<h4>Make<a class="headerlink" href="linker-script-generation.html#make" title="Permalink to this headline">¶</a></h4>
<p>In the component’s <code class="docutils literal notranslate"><span class="pre">component.mk</span></code> file, set the variable <code class="docutils literal notranslate"><span class="pre">COMPONENT_ADD_LDFRAGMENTS</span></code> to the path of the created linker
fragment file. The path can either be an absolute path or a relative path from the component directory.</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="nv">COMPONENT_ADD_LDFRAGMENTS</span> <span class="o">+=</span> <span class="s2">&quot;my_linker_fragment_file.lf&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="cmake">
<h4>CMake<a class="headerlink" href="linker-script-generation.html#cmake" title="Permalink to this headline">¶</a></h4>
<p>In the component’s <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file, specify argument <code class="docutils literal notranslate"><span class="pre">LDFRAGMENTS</span></code> in the <code class="docutils literal notranslate"><span class="pre">idf_component_register</span></code> call.
The value of <code class="docutils literal notranslate"><span class="pre">LDFRAGMENTS</span></code> can either be an absolute path or a relative path from the component directory to the
created linker fragment file.</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="c"># file paths relative to CMakeLists.txt</span>
<span class="nb">idf_component_register</span><span class="p">(</span><span class="s">...</span>
                       <span class="s">LDFRAGMENTS</span> <span class="s2">&quot;path/to/linker_fragment_file.lf&quot;</span> <span class="s2">&quot;path/to/another_linker_fragment_file.lf&quot;</span>
                       <span class="s">...</span>
                       <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="specifying-placements">
<h3>Specifying placements<a class="headerlink" href="linker-script-generation.html#specifying-placements" title="Permalink to this headline">¶</a></h3>
<p>It is possible to specify placements at the following levels of granularity:</p>
<blockquote>
<div><ul class="simple">
<li>object file (<code class="docutils literal notranslate"><span class="pre">.obj</span></code> or <code class="docutils literal notranslate"><span class="pre">.o</span></code> files)</li>
<li>symbol (function/variable)</li>
<li>archive (<code class="docutils literal notranslate"><span class="pre">.a</span></code> files)</li>
</ul>
</div></blockquote>
<div class="section" id="placing-object-files">
<span id="ldgen-placing-object-files"></span><h4>Placing object files<a class="headerlink" href="linker-script-generation.html#placing-object-files" title="Permalink to this headline">¶</a></h4>
<p>Suppose the entirety of <code class="docutils literal notranslate"><span class="pre">my_src1.o</span></code> is performance-critical, so it is desirable to place it in RAM.
On the other hand, the entirety of <code class="docutils literal notranslate"><span class="pre">my_src2.o</span></code> contains symbols needed coming out of deep sleep, so it needs to be put under RTC memory.
In the the linker fragment file, we can write:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:my_component]
archive: libmy_component.a
entries:
    my_src1 (noflash)     # places all my_src1 code/read-only data under IRAM/DRAM
    my_src2 (rtc)         # places all my_src2 code/ data and read-only data under RTC fast memory/RTC slow memory
</pre></div>
</div>
<p>What happens to <code class="docutils literal notranslate"><span class="pre">my_src3.o</span></code>? Since it is not specified, default placements are used for <code class="docutils literal notranslate"><span class="pre">my_src3.o</span></code>. More on default placements
<a class="reference internal" href="linker-script-generation.html#ldgen-default-placements"><span class="std std-ref">here</span></a>.</p>
</div>
<div class="section" id="placing-symbols">
<h4>Placing symbols<a class="headerlink" href="linker-script-generation.html#placing-symbols" title="Permalink to this headline">¶</a></h4>
<p>Continuing our example, suppose that among functions defined under <code class="docutils literal notranslate"><span class="pre">object1.o</span></code>, only <code class="docutils literal notranslate"><span class="pre">my_function1</span></code> is performance-critical; and under <code class="docutils literal notranslate"><span class="pre">object2.o</span></code>,
only <code class="docutils literal notranslate"><span class="pre">my_function2</span></code> needs to execute after the chip comes out of deep sleep. This could be accomplished by writing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:my_component]
archive: libmy_component.a
entries:
    my_src1:my_function1 (noflash)
    my_src2:my_function2 (rtc)
</pre></div>
</div>
<p>The default placements are used for the rest of the functions in <code class="docutils literal notranslate"><span class="pre">my_src1.o</span></code> and <code class="docutils literal notranslate"><span class="pre">my_src2.o</span></code> and the entire <code class="docutils literal notranslate"><span class="pre">object3.o</span></code>. Something similar
can be achieved for placing data by writing the variable name instead of the function name, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_src1</span><span class="p">:</span><span class="n">my_variable</span> <span class="p">(</span><span class="n">noflash</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">There are <a class="reference internal" href="linker-script-generation.html#ldgen-symbol-granularity-placements"><span class="std std-ref">limitations</span></a> in placing code/data at symbol granularity. In order to ensure proper placements, an alternative would be to group
relevant code and data into source files, and <a class="reference internal" href="linker-script-generation.html#ldgen-placing-object-files"><span class="std std-ref">use object-granularity placements</span></a>.</p>
</div>
</div>
<div class="section" id="placing-entire-archive">
<h4>Placing entire archive<a class="headerlink" href="linker-script-generation.html#placing-entire-archive" title="Permalink to this headline">¶</a></h4>
<p>In this example, suppose that the entire component archive needs to be placed in RAM. This can be written as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:my_component]
archive: libmy_component.a
entries:
    * (noflash)
</pre></div>
</div>
<p>Similarly, this places the entire component in RTC memory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:my_component]
archive: libmy_component.a
entries:
    * (rtc)
</pre></div>
</div>
</div>
<div class="section" id="configuration-dependent-placements">
<h4>Configuration-dependent placements<a class="headerlink" href="linker-script-generation.html#configuration-dependent-placements" title="Permalink to this headline">¶</a></h4>
<p>Suppose that the entire component library should only have special placement when a certain condition is true; for example, when <code class="docutils literal notranslate"><span class="pre">CONFIG_PERFORMANCE_MODE</span> <span class="pre">==</span> <span class="pre">y</span></code>.
This could be written as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:my_component]
archive: libmy_component.a
entries:
    if PERFORMANCE_MODE = y:
        * (noflash)
    else:
        * (default)
</pre></div>
</div>
<p>For a more complex config-dependent placement, suppose the following requirements: when <code class="docutils literal notranslate"><span class="pre">CONFIG_PERFORMANCE_LEVEL</span> <span class="pre">==</span> <span class="pre">1</span></code>, only <code class="docutils literal notranslate"><span class="pre">object1.o</span></code> is put in RAM;
when <code class="docutils literal notranslate"><span class="pre">CONFIG_PERFORMANCE_LEVEL</span> <span class="pre">==</span> <span class="pre">2</span></code>, <code class="docutils literal notranslate"><span class="pre">object1.o</span></code> and <code class="docutils literal notranslate"><span class="pre">object2.o</span></code>; and when <code class="docutils literal notranslate"><span class="pre">CONFIG_PERFORMANCE_LEVEL</span> <span class="pre">==</span> <span class="pre">3</span></code> all object files under the archive
are to be put into RAM. When these three are false however, put entire library in RTC memory. This scenario is a bit contrived, but,
it can be written as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:my_component]
archive: libmy_component.a
entries:
    if PERFORMANCE_LEVEL = 1:
        my_src1 (noflash)
    elif PERFORMANCE_LEVEL = 2:
        my_src1 (noflash)
        my_src2 (noflash)
    elif PERFORMANCE_LEVEL = 3:
        my_src1 (noflash)
        my_src2 (noflash)
        my_src3 (noflash)
    else:
        * (rtc)
</pre></div>
</div>
<p>Nesting condition-checking is also possible. The following is equivalent to the snippet above:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:my_component]
archive: libmy_component.a
entries:
    if PERFORMANCE_LEVEL &lt;= 3 &amp;&amp; PERFORMANCE_LEVEL &gt; 0:
        if PERFORMANCE_LEVEL &gt;= 1:
            object1 (noflash)
            if PERFORMANCE_LEVEL &gt;= 2:
                object2 (noflash)
                if PERFORMANCE_LEVEL &gt;= 3:
                    object2 (noflash)
    else:
        * (rtc)
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-default-placements">
<span id="ldgen-default-placements"></span><h3>The ‘default’ placements<a class="headerlink" href="linker-script-generation.html#the-default-placements" title="Permalink to this headline">¶</a></h3>
<p>Up until this point, the term  ‘default placements’ has been mentioned as fallback placements for when the
placement rules <code class="docutils literal notranslate"><span class="pre">rtc</span></code> and <code class="docutils literal notranslate"><span class="pre">noflash</span></code> are not specified. It is important to note that the tokens <code class="docutils literal notranslate"><span class="pre">noflash</span></code> or <code class="docutils literal notranslate"><span class="pre">rtc</span></code> are not merely keywords, but are actually
entities called fragments, specifically <a class="reference internal" href="linker-script-generation.html#ldgen-scheme-fragment"><span class="std std-ref">schemes</span></a>.</p>
<p>In the same manner as <code class="docutils literal notranslate"><span class="pre">rtc</span></code> and <code class="docutils literal notranslate"><span class="pre">noflash</span></code> are schemes, there exists a <code class="docutils literal notranslate"><span class="pre">default</span></code> scheme which defines what the default placement rules should be.
As the name suggests, it is where code and data are usually placed, i.e. code/constants is placed in flash, variables
placed in RAM, etc.  More on the default scheme <a class="reference internal" href="linker-script-generation.html#ldgen-default-scheme"><span class="std std-ref">here</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For an example of an ESP-IDF component using the linker script generation mechanism, see <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637/components/freertos/CMakeLists.txt">freertos/CMakeLists.txt</a>.
<code class="docutils literal notranslate"><span class="pre">freertos</span></code> uses this to place its object files to the instruction RAM for performance reasons.</p>
</div>
<p>This marks the end of the quick start guide. The following text discusses the internals of the mechanism in a little bit more detail.
The following sections should be helpful in creating custom placements or modifying default behavior.</p>
</div>
</div>
<div class="section" id="linker-script-generation-internals">
<h2>Linker Script Generation Internals<a class="headerlink" href="linker-script-generation.html#linker-script-generation-internals" title="Permalink to this headline">¶</a></h2>
<p>Linking is the last step in the process of turning C/C++ source files into an executable. It is performed by the toolchain’s linker, and accepts
linker scripts which specify code/data placements, among other things. With the linker script generation mechanism, this process is no different, except
that the linker script passed to the linker is dynamically generated from: (1) the collected <a class="reference internal" href="linker-script-generation.html#ldgen-linker-fragment-files"><span class="std std-ref">linker fragment files</span></a> and
(2) <a class="reference internal" href="linker-script-generation.html#ldgen-linker-script-template"><span class="std std-ref">linker script template</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The tool that implements the linker script generation mechanism lives under <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/tools/ldgen">tools/ldgen</a>.</p>
</div>
<div class="section" id="linker-fragment-files">
<span id="ldgen-linker-fragment-files"></span><h3>Linker Fragment Files<a class="headerlink" href="linker-script-generation.html#linker-fragment-files" title="Permalink to this headline">¶</a></h3>
<p>As mentioned in the quick start guide, fragment files are simple text files with the <code class="docutils literal notranslate"><span class="pre">.lf</span></code> extension containing the desired placements. This is a simplified
description of what fragment files contain, however. What fragment files actually contain are ‘fragments’. Fragments are entities which contain pieces of information which, when put together, form
placement rules that tell where to place sections of object files in the output binary. There are three types of fragments: <a class="reference internal" href="linker-script-generation.html#ldgen-sections-fragment"><span class="std std-ref">sections</span></a>,
<a class="reference internal" href="linker-script-generation.html#ldgen-scheme-fragment"><span class="std std-ref">scheme</span></a> and <a class="reference internal" href="linker-script-generation.html#ldgen-mapping-fragment"><span class="std std-ref">mapping</span></a>.</p>
<div class="section" id="grammar">
<h4>Grammar<a class="headerlink" href="linker-script-generation.html#grammar" title="Permalink to this headline">¶</a></h4>
<p>The three fragment types share a common grammar:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[type:name]
key: value
key:
    value
    value
    value
    ...
</pre></div>
</div>
<ul class="simple">
<li>type: Corresponds to the fragment type, can either be <code class="docutils literal notranslate"><span class="pre">sections</span></code>, <code class="docutils literal notranslate"><span class="pre">scheme</span></code> or <code class="docutils literal notranslate"><span class="pre">mapping</span></code>.</li>
<li>name: The name of the fragment, should be unique for the specified fragment type.</li>
<li>key, value: Contents of the fragment; each fragment type may support different keys and different grammars for the key values.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In cases where multiple fragments of the same type and name are encountered, an exception is thrown.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The only valid characters for fragment names and keys are alphanumeric characters and underscore.</p>
</div>
<p id="ldgen-condition-checking"><strong>Condition Checking</strong></p>
<p>Condition checking enable the linker script generation to be configuration-aware. Depending on whether expressions involving configuration values
are true or not, a particular set of values for a key can be used. The evaluation uses <code class="docutils literal notranslate"><span class="pre">eval_string</span></code> from <a class="reference external" href="https://github.com/espressif/esp-idf/blob/f91080637/tools/kconfig_new/kconfiglib.py">tools/kconfig_new/kconfiglib.py</a>
and adheres to its required syntax and limitations. Supported operators are as follows:</p>
<blockquote>
<div><ul class="simple">
<li><dl class="first docutils">
<dt>comparison</dt>
<dd><ul class="first last">
<li>LessThan <code class="docutils literal notranslate"><span class="pre">&lt;</span></code></li>
<li>LessThanOrEqualTo <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code></li>
<li>MoreThan <code class="docutils literal notranslate"><span class="pre">&gt;</span></code></li>
<li>MoreThanOrEqualTo <code class="docutils literal notranslate"><span class="pre">&gt;=</span></code></li>
<li>Equal <code class="docutils literal notranslate"><span class="pre">=</span></code></li>
<li>NotEqual <code class="docutils literal notranslate"><span class="pre">!=</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>logical</dt>
<dd><ul class="first last">
<li>Or <code class="docutils literal notranslate"><span class="pre">||</span></code></li>
<li>And <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code></li>
<li>Negation <code class="docutils literal notranslate"><span class="pre">!</span></code></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>grouping</dt>
<dd><ul class="first last">
<li>Parenthesis <code class="docutils literal notranslate"><span class="pre">()</span></code></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p>Condition checking behaves as you would expect an <code class="docutils literal notranslate"><span class="pre">if...elseif/elif...else</span></code> block in other languages. Condition-checking is possible
for both key values and entire fragments. The two sample fragments below are equivalent:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Value for keys is dependent on config
[type:name]
key_1:
    if CONDITION = y:
        value_1
    else:
        value_2
key_2:
    if CONDITION = y:
        value_a
    else:
        value_b
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Entire fragment definition is dependent on config
if CONDITION = y:
    [type:name]
    key_1:
        value_1
    key_2:
        value_b
else:
    [type:name]
    key_1:
        value_2
    key_2:
        value_b
</pre></div>
</div>
<p><strong>Comments</strong></p>
<p>Comment in linker fragment files begin with <code class="docutils literal notranslate"><span class="pre">#</span></code>. Like in other languages, comment are used to provide helpful descriptions and documentation
and are ignored during processing.</p>
</div>
<div class="section" id="compatibility-with-esp-idf-v3-x-linker-script-fragment-files">
<h4>Compatibility with ESP-IDF v3.x Linker Script Fragment Files<a class="headerlink" href="linker-script-generation.html#compatibility-with-esp-idf-v3-x-linker-script-fragment-files" title="Permalink to this headline">¶</a></h4>
<p>ESP-IDF v4.0 brings some changes to the linker script fragment file grammar:</p>
<ul class="simple">
<li><dl class="first docutils">
<dt>indentation is enforced and improperly indented fragment files generate a parse exception; this was not enforced in the old version but previous documentation</dt>
<dd>and examples demonstrates properly indented grammar</dd>
</dl>
</li>
<li>move to <code class="docutils literal notranslate"><span class="pre">if...elif...else</span></code> structure for conditionals, with the ability to nest checks and place entire fragments themselves inside conditionals</li>
<li>mapping fragments now requires a name like other fragment types</li>
</ul>
<p>Linker script generator should be able to parse ESP-IDF v3.x linker fragment files that are indented properly (as demonstrated by
the ESP-IDF v3.x version of this document). Backward compatibility with the previous mapping fragment grammar (optional
name and the old grammar for conditionals) has also been retained but with a deprecation warning. Users should switch to the newer grammar discussed
in this document as support for the old grammar is planned to be removed in the future.</p>
<p>Note that linker fragment files using the new ESP-IDF v4.0 grammar is not supported on ESP-IDF v3.x, however.</p>
</div>
<div class="section" id="types">
<h4>Types<a class="headerlink" href="linker-script-generation.html#types" title="Permalink to this headline">¶</a></h4>
<p id="ldgen-sections-fragment"><strong>Sections</strong></p>
<p>Sections fragments defines a list of object file sections that the GCC compiler emits. It may be a default section (e.g. <code class="docutils literal notranslate"><span class="pre">.text</span></code>, <code class="docutils literal notranslate"><span class="pre">.data</span></code>) or
it may be user defined section through the <code class="docutils literal notranslate"><span class="pre">__attribute__</span></code> keyword.</p>
<p>The use of an optional ‘+’ indicates the inclusion of the section in the list, as well as sections that start with it. This is the preferred method over listing both explicitly.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[sections:name]
entries:
    .section+
    .section
    ...
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># Non-preferred
[sections:text]
entries:
    .text
    .text.*
    .literal
    .literal.*

# Preferred, equivalent to the one above
[sections:text]
entries:
    .text+              # means .text and .text.*
    .literal+           # means .literal and .literal.*
</pre></div>
</div>
<p id="ldgen-scheme-fragment"><strong>Scheme</strong></p>
<p>Scheme fragments define what <code class="docutils literal notranslate"><span class="pre">target</span></code> a sections fragment is assigned to.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[scheme:name]
entries:
    sections -&gt; target
    sections -&gt; target
    ...
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[scheme:noflash]
entries:
    text -&gt; iram0_text          # the entries under the sections fragment named text will go to iram0_text
    rodata -&gt; dram0_data        # the entries under the sections fragment named rodata will go to dram0_data
</pre></div>
</div>
<p id="ldgen-default-scheme">The <code class="docutils literal notranslate"><span class="pre">default</span></code> scheme</p>
<p>There exists a special scheme with the name <code class="docutils literal notranslate"><span class="pre">default</span></code>. This scheme is special because catch-all placement rules are generated from
its entries. This means that, if one of its entries is <code class="docutils literal notranslate"><span class="pre">text</span> <span class="pre">-&gt;</span> <span class="pre">flash_text</span></code>, the placement rule</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>*(.literal .literal.* .text .text.*)
</pre></div>
</div>
<p>will be generated for the target <code class="docutils literal notranslate"><span class="pre">flash_text</span></code>.</p>
<p>These catch-all rules then effectively serve as fallback rules for those whose mappings were not specified.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">default</span> <span class="pre">scheme</span></code> is defined in <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/components/esp32/ld/esp32_fragments.lf">esp32/ld/esp32_fragments.lf</a>. The <code class="docutils literal notranslate"><span class="pre">noflash</span></code> and <code class="docutils literal notranslate"><span class="pre">rtc</span></code> scheme fragments which are
built-in schemes referenced in the quick start guide are also defined in this file.</p>
</div>
<p id="ldgen-mapping-fragment"><strong>Mapping</strong></p>
<p>Mapping fragments define what scheme fragment to use for mappable entities, i.e. object files, function names, variable names, archives.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:name]
archive: archive                # output archive file name, as built (i.e. libxxx.a)
entries:
    object:symbol (scheme)      # symbol granularity
    object (scheme)             # object granularity
    * (scheme)                  # archive granularity
</pre></div>
</div>
<p>There are three levels of placement granularity:</p>
<blockquote>
<div><ul class="simple">
<li>symbol: The object file name and symbol name are specified. The symbol name can be a function name or a variable name.</li>
<li>object: Only the object file name is specified.</li>
<li>archive: <code class="docutils literal notranslate"><span class="pre">*</span></code> is specified, which is a short-hand for all the object files under the archive.</li>
</ul>
</div></blockquote>
<p>To know what an entry means, let us expand a sample object-granularity placement:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>object (scheme)
</pre></div>
</div>
<p>Then expanding the scheme fragment from its entries definitions, we have:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>object (sections -&gt; target,
        sections -&gt; target,
        ...)
</pre></div>
</div>
<p>Expanding the sections fragment with its entries definition:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>object (.section,      # given this object file
        .section,      # put its sections listed here at this
        ... -&gt; target, # target

        .section,
        .section,      # same should be done for these sections
        ... -&gt; target,

        ...)           # and so on
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[mapping:map]
archive: libfreertos.a
entries:
    * (noflash)
</pre></div>
</div>
</div>
<div class="section" id="on-symbol-granularity-placements">
<span id="ldgen-symbol-granularity-placements"></span><h4>On Symbol-Granularity Placements<a class="headerlink" href="linker-script-generation.html#on-symbol-granularity-placements" title="Permalink to this headline">¶</a></h4>
<p>Symbol granularity placements is possible due to compiler flags <code class="docutils literal notranslate"><span class="pre">-ffunction-sections</span></code> and <code class="docutils literal notranslate"><span class="pre">-ffdata-sections</span></code>. ESP-IDF compiles with these flags by default.
If the user opts to remove these flags, then the symbol-granularity placements will not work. Furthermore, even with the presence of these flags, there are still other limitations to keep in mind
due to the dependence on the compiler’s emitted output sections.</p>
<p>For example, with <code class="docutils literal notranslate"><span class="pre">-ffunction-sections</span></code>, separate sections are emitted for each function; with section names predictably constructed i.e. <code class="docutils literal notranslate"><span class="pre">.text.{func_name}</span></code>
and <code class="docutils literal notranslate"><span class="pre">.literal.{func_name}</span></code>. This is not the case for string literals within the function, as they go to pooled or generated section names.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">-fdata-sections</span></code>, for global scope data the compiler predictably emits either <code class="docutils literal notranslate"><span class="pre">.data.{var_name}</span></code>, <code class="docutils literal notranslate"><span class="pre">.rodata.{var_name}</span></code> or <code class="docutils literal notranslate"><span class="pre">.bss.{var_name}</span></code>; and so <code class="docutils literal notranslate"><span class="pre">Type</span> <span class="pre">I</span></code> mapping entry works for these.
However, this is not the case for static data declared in function scope, as the generated section name is a result of mangling the variable name with some other information.</p>
</div>
</div>
<div class="section" id="linker-script-template">
<span id="ldgen-linker-script-template"></span><h3>Linker Script Template<a class="headerlink" href="linker-script-generation.html#linker-script-template" title="Permalink to this headline">¶</a></h3>
<p>The linker script template is the skeleton in which the generated placement rules are put into. It is an otherwise ordinary linker script, with a specific marker syntax
that indicates where the generated placement rules are placed.</p>
<p>To reference the placement rules collected under a <code class="docutils literal notranslate"><span class="pre">target</span></code> token, the following syntax is used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>mapping[target]
</pre></div>
</div>
<p>Example:</p>
<p>The example below is an excerpt from a possible linker script template. It defines an output section <code class="docutils literal notranslate"><span class="pre">.iram0.text</span></code>, and inside is a marker referencing
the target <code class="docutils literal notranslate"><span class="pre">iram0_text</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>.iram0.text :
{
    /* Code marked as runnning out of IRAM */
    _iram_text_start = ABSOLUTE(.);

    /* Marker referencing iram0_text */
    mapping[iram0_text]

    _iram_text_end = ABSOLUTE(.);
} &gt; iram0_0_seg
</pre></div>
</div>
<p>Suppose the generator collected the fragment definitions below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[sections:text]
    .text+
    .literal+

[sections:iram]
    .iram1+

[scheme:default]
entries:
    text -&gt; flash_text
    iram -&gt; iram0_text

[scheme:noflash]
entries:
    text -&gt; iram0_text

[mapping:freertos]
archive: libfreertos.a
entries:
    * (noflash)
</pre></div>
</div>
<p>Then the corresponding excerpt from the generated linker script will be as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">iram0</span><span class="p">.</span><span class="nl">text</span> <span class="p">:</span>
<span class="p">{</span>
    <span class="cm">/* Code marked as runnning out of IRAM */</span>
    <span class="n">_iram_text_start</span> <span class="o">=</span> <span class="n">ABSOLUTE</span><span class="p">(.);</span>

    <span class="cm">/* Placement rules generated from the processed fragments, placed where the marker was in the template */</span>
    <span class="o">*</span><span class="p">(.</span><span class="n">iram1</span> <span class="p">.</span><span class="n">iram1</span><span class="p">.</span><span class="o">*</span><span class="p">)</span>
    <span class="o">*</span><span class="n">libfreertos</span><span class="p">.</span><span class="nl">a</span><span class="p">:(.</span><span class="n">literal</span> <span class="p">.</span><span class="n">text</span> <span class="p">.</span><span class="n">literal</span><span class="p">.</span><span class="o">*</span> <span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="o">*</span><span class="p">)</span>

    <span class="n">_iram_text_end</span> <span class="o">=</span> <span class="n">ABSOLUTE</span><span class="p">(.);</span>
<span class="p">}</span> <span class="o">&gt;</span> <span class="n">iram0_0_seg</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">*libfreertos.a:(.literal</span> <span class="pre">.text</span> <span class="pre">.literal.*</span> <span class="pre">.text.*)</span></code></p>
<blockquote>
<div>Rule generated from the entry <code class="docutils literal notranslate"><span class="pre">*</span> <span class="pre">(noflash)</span></code> of the <code class="docutils literal notranslate"><span class="pre">freertos</span></code> mapping fragment. All <code class="docutils literal notranslate"><span class="pre">text</span></code> sections of all
object files under the archive <code class="docutils literal notranslate"><span class="pre">libfreertos.a</span></code> will be collected under the target <code class="docutils literal notranslate"><span class="pre">iram0_text</span></code> (as per the <code class="docutils literal notranslate"><span class="pre">noflash</span></code> scheme)
and placed wherever in the template <code class="docutils literal notranslate"><span class="pre">iram0_text</span></code> is referenced by a marker.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">*(.iram1</span> <span class="pre">.iram1.*)</span></code></p>
<blockquote>
<div>Rule generated from the default scheme entry        <code class="docutils literal notranslate"><span class="pre">iram</span> <span class="pre">-&gt;</span> <span class="pre">iram0_text</span></code>. Since the default scheme specifies an <code class="docutils literal notranslate"><span class="pre">iram</span> <span class="pre">-&gt;</span> <span class="pre">iram0_text</span></code> entry,
it too is placed wherever <code class="docutils literal notranslate"><span class="pre">iram0_text</span></code> is referenced by a marker. Since it is a rule generated from the default scheme, it comes first
among all other rules collected under the same target name.</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The linker script template currently used is <a class="reference external" href="https://github.com/espressif/esp-idf/tree/f91080637/components/esp32/ld/esp32.project.ld.in">esp32/ld/esp32.project.ld.in</a>, specified by the <code class="docutils literal notranslate"><span class="pre">esp32</span></code> component; the
generated output script is put under its build directory.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lwip.html" class="btn btn-neutral float-right" title="lwIP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="jtag-debugging/tips-and-quirks.html" class="btn btn-neutral float-left" title="Tips and Quirks" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016 - 2019, Espressif Systems (Shanghai) CO., LTD
      
        <span class="commit">
          Revision <code>f9108063</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>